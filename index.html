<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Stok Opname OCR Kamera dengan Fokus</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 400px;
      margin: auto;
    }
    .video-container {
      position: relative;
      width: 100%;
      max-width: 400px;
      margin: auto;
    }
    #video {
      width: 100%;
      border-radius: 5px;
      border: 1px solid #ccc;
      display: block;
    }
    /* Kotak fokus di tengah video */
    #focus-box {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 180px;
      height: 100px;
      margin-left: -90px; /* setengah width */
      margin-top: -50px;  /* setengah height */
      border: 3px solid #00ff00;
      border-radius: 8px;
      box-sizing: border-box;
      pointer-events: none; /* supaya tidak mengganggu klik */
      mix-blend-mode: difference; /* biar kontras */
    }
    button {
      margin-top: 10px;
      padding: 10px;
      width: 100%;
      font-size: 16px;
      cursor: pointer;
      background-color: #007bff;
      border: none;
      color: white;
      border-radius: 5px;
    }
    button:disabled {
      background-color: #888;
      cursor: not-allowed;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #aaa;
      padding: 6px;
      text-align: center;
    }
    .delete-btn {
      background-color: #dc3545;
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
    }
    #resultMessage {
      margin-top: 10px;
      min-height: 24px;
      font-weight: bold;
      text-align: center;
      color: green;
    }
  </style>
</head>
<body>

<h2>Stok Opname dengan OCR Kamera + Fokus</h2>

<div class="video-container">
  <video id="video" autoplay></video>
  <div id="focus-box"></div>
</div>

<button id="scanBtn">Scan Angka</button>
<div id="resultMessage"></div>

<table>
  <thead>
    <tr><th>No</th><th>Angka Hasil Scan</th><th>Aksi</th></tr>
  </thead>
  <tbody id="scanListBody"></tbody>
  <tfoot>
    <tr><td><b>Total</b></td><td id="totalValue">0</td><td></td></tr>
  </tfoot>
</table>

<canvas id="canvas" style="display:none;"></canvas>

<script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const scanBtn = document.getElementById('scanBtn');
  const scanListBody = document.getElementById('scanListBody');
  const totalValueCell = document.getElementById('totalValue');
  const resultMessage = document.getElementById('resultMessage');
  const focusBox = document.getElementById('focus-box');

  let scanResults = [];

  // Kamera dengan facingMode environment (kamera belakang hp)
  navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(stream => {
      video.srcObject = stream;
    })
    .catch(err => {
      alert('Tidak bisa akses kamera: ' + err);
    });

  function updateTable() {
    scanListBody.innerHTML = '';
    scanResults.forEach((num, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i + 1}</td>
        <td>${num}</td>
        <td><button class="delete-btn" data-index="${i}">Hapus</button></td>
      `;
      scanListBody.appendChild(tr);
    });

    const total = scanResults.reduce((acc, val) => acc + val, 0);
    totalValueCell.textContent = total;
  }

  scanListBody.addEventListener('click', (e) => {
    if(e.target.classList.contains('delete-btn')) {
      const index = parseInt(e.target.getAttribute('data-index'));
      if(!isNaN(index)) {
        scanResults.splice(index, 1);
        updateTable();
        resultMessage.textContent = 'Data berhasil dihapus.';
        resultMessage.style.color = 'green';
      }
    }
  });

  scanBtn.addEventListener('click', () => {
    resultMessage.style.color = 'black';
    resultMessage.textContent = 'Memproses gambar...';
    scanBtn.disabled = true;

    // Ambil area fokus dari kotak fokus (crop image area yang di-scan)
    const videoRect = video.getBoundingClientRect();
    const focusRect = focusBox.getBoundingClientRect();

    const scaleX = video.videoWidth / videoRect.width;
    const scaleY = video.videoHeight / videoRect.height;

    const cropX = (focusRect.left - videoRect.left) * scaleX;
    const cropY = (focusRect.top - videoRect.top) * scaleY;
    const cropWidth = focusRect.width * scaleX;
    const cropHeight = focusRect.height * scaleY;

    const ctx = canvas.getContext('2d');
    canvas.width = cropWidth;
    canvas.height = cropHeight;

    ctx.drawImage(video, cropX, cropY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);

    canvas.toBlob(blob => {
      Tesseract.recognize(blob, 'eng', {
        logger: m => {
          //console.log(m);
        }
      }).then(({ data: { text } }) => {
        const angkaStr = text.replace(/\D/g, '');
        if(angkaStr.length === 0) {
          resultMessage.style.color = 'red';
          resultMessage.textContent = 'Tidak ada angka terdeteksi, coba ulangi.';
        } else {
          const angka = parseInt(angkaStr, 10);
          scanResults.push(angka);
          updateTable();
          resultMessage.style.color = 'green';
          resultMessage.textContent = `Berhasil scan angka: ${angka}`;
        }
        scanBtn.disabled = false;
      }).catch(err => {
        resultMessage.style.color = 'red';
        resultMessage.textContent = 'Gagal membaca gambar: ' + err;
        scanBtn.disabled = false;
      });
    });
  });
</script>

</body>
</html>


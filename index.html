<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Stok Opname - Klik Angka dari Gambar</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 500px;
      margin: auto;
    }
    video, canvas, img {
      width: 100%;
      max-width: 100%;
      margin-top: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      margin-top: 10px;
      padding: 10px;
      width: 100%;
      font-size: 16px;
      cursor: pointer;
      background-color: #007bff;
      border: none;
      color: white;
      border-radius: 5px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #aaa;
      padding: 6px;
      text-align: center;
    }
    .delete-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
    }
    #resultMessage {
      margin-top: 10px;
      font-weight: bold;
      text-align: center;
      min-height: 20px;
    }
  </style>
</head>
<body>

<h2>Stok Opname - Klik Angka dari Gambar</h2>

<video id="video" autoplay></video>
<button id="captureBtn">Capture Gambar</button>
<canvas id="canvas" style="display:none;"></canvas>
<img id="capturedImg" alt="Gambar Hasil Capture" />

<p>Klik di gambar hasil capture pada bagian angka untuk proses OCR.</p>

<div id="resultMessage"></div>

<table>
  <thead>
    <tr><th>No</th><th>Hasil Scan</th><th>Aksi</th></tr>
  </thead>
  <tbody id="scanListBody"></tbody>
  <tfoot>
    <tr><td><b>Total</b></td><td id="totalValue">0</td><td></td></tr>
  </tfoot>
</table>

<script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const img = document.getElementById('capturedImg');
  const captureBtn = document.getElementById('captureBtn');
  const resultMessage = document.getElementById('resultMessage');
  const scanListBody = document.getElementById('scanListBody');
  const totalValueCell = document.getElementById('totalValue');

  let scanResults = [];

  function formatRibuan(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }

  // Akses kamera
  navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(stream => {
      video.srcObject = stream;
    })
    .catch(err => {
      alert("Tidak bisa akses kamera: " + err);
    });

  // Capture dari video
  captureBtn.addEventListener('click', () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    img.src = canvas.toDataURL('image/png');
    resultMessage.textContent = "Gambar berhasil diambil. Klik pada angka untuk OCR.";
    resultMessage.style.color = "green";
  });

  // Klik gambar untuk scan angka
  img.addEventListener('click', (e) => {
    if (!img.src) return;

    const rect = img.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const x = (e.clientX - rect.left) * scaleX;
    const y = (e.clientY - rect.top) * scaleY;

    const cropSize = 150; // Ukuran kotak OCR
    const cropX = Math.max(0, x - cropSize / 2);
    const cropY = Math.max(0, y - cropSize / 2);
    const ctx = canvas.getContext('2d');

    const imageData = ctx.getImageData(cropX, cropY, cropSize, cropSize);
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = cropSize;
    tempCanvas.height = cropSize;
    tempCanvas.getContext('2d').putImageData(imageData, 0, 0);

    resultMessage.textContent = "Memproses angka...";
    resultMessage.style.color = "black";

    tempCanvas.toBlob(blob => {
      Tesseract.recognize(blob, 'eng', {
        logger: m => {}
      }).then(({ data: { text } }) => {
        const angkaStr = text.replace(/\D/g, '');
        if (angkaStr.length === 0) {
          resultMessage.textContent = "Tidak ada angka terdeteksi.";
          resultMessage.style.color = "red";
        } else {
          const angka = parseInt(angkaStr, 10);
          scanResults.push(angka);
          updateTable();
          resultMessage.textContent = "Berhasil scan: " + formatRibuan(angka);
          resultMessage.style.color = "green";
        }
      }).catch(err => {
        resultMessage.textContent = "Gagal membaca angka: " + err;
        resultMessage.style.color = "red";
      });
    });
  });

  function updateTable() {
    scanListBody.innerHTML = '';
    scanResults.forEach((num, i) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${i + 1}</td>
        <td>${formatRibuan(num)}</td>
        <td><button class="delete-btn" data-index="${i}">Hapus</button></td>
      `;
      scanListBody.appendChild(row);
    });

    const total = scanResults.reduce((acc, val) => acc + val, 0);
    totalValueCell.textContent = formatRibuan(total);
  }

  // Hapus angka
  scanListBody.addEventListener('click', e => {
    if (e.target.classList.contains('delete-btn')) {
      const index = parseInt(e.target.getAttribute('data-index'));
      scanResults.splice(index, 1);
      updateTable();
      resultMessage.textContent = "Data berhasil dihapus.";
      resultMessage.style.color = "green";
    }
  });
</script>

</body>
</html>

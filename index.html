<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>Stok Opname - Capture, Pilih Area, Putar Manual, OCR</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    max-width: 520px;
    margin: auto;
  }
  video, img, canvas {
    width: 100%;
    max-width: 100%;
    border: 1px solid #ccc;
    border-radius: 6px;
    margin-top: 10px;
  }
  button {
    margin-top: 10px;
    padding: 10px;
    width: 100%;
    font-size: 16px;
    cursor: pointer;
    background-color: #007bff;
    border: none;
    color: white;
    border-radius: 5px;
  }
  #rotateCropBtn, #scanCropBtn {
    width: 48%;
    display: inline-block;
    margin-top: 10px;
  }
  #rotateCropBtn {
    background-color: #28a745;
  }
  #scanCropBtn {
    background-color: #17a2b8;
  }
  #cropPreviewContainer {
    margin-top: 10px;
    position: relative;
    text-align: center;
  }
  #cropPreview {
    border: 1px solid #555;
    max-width: 150px;
    max-height: 150px;
    display: block;
    margin: auto;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  th, td {
    border: 1px solid #aaa;
    padding: 6px;
    text-align: center;
  }
  .delete-btn {
    background-color: #dc3545;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 4px 8px;
    cursor: pointer;
  }
  #resultMessage {
    margin-top: 10px;
    font-weight: bold;
    text-align: center;
    min-height: 20px;
  }
</style>
</head>
<body>

<h2>Stok Opname - Capture, Pilih Area, Putar Manual, OCR</h2>

<video id="video" autoplay></video>
<button id="captureBtn">Capture Gambar</button>
<img id="capturedImg" alt="Gambar Hasil Capture" />

<div id="cropPreviewContainer" style="display:none;">
  <p>Preview Area Crop (Klik rotate dan scan setelah pas)</p>
  <canvas id="cropPreview"></canvas>
  <button id="rotateCropBtn">Putar 90°</button>
  <button id="scanCropBtn">Scan Angka</button>
</div>

<div id="resultMessage"></div>

<table>
  <thead>
    <tr><th>No</th><th>Hasil Scan</th><th>Aksi</th></tr>
  </thead>
  <tbody id="scanListBody"></tbody>
  <tfoot>
    <tr><td><b>Total</b></td><td id="totalValue">0</td><td></td></tr>
  </tfoot>
</table>

<canvas id="hiddenCanvas" style="display:none;"></canvas>

<script>
  const video = document.getElementById('video');
  const captureBtn = document.getElementById('captureBtn');
  const capturedImg = document.getElementById('capturedImg');
  const cropPreviewContainer = document.getElementById('cropPreviewContainer');
  const cropPreview = document.getElementById('cropPreview');
  const rotateCropBtn = document.getElementById('rotateCropBtn');
  const scanCropBtn = document.getElementById('scanCropBtn');
  const resultMessage = document.getElementById('resultMessage');
  const scanListBody = document.getElementById('scanListBody');
  const totalValueCell = document.getElementById('totalValue');
  const hiddenCanvas = document.getElementById('hiddenCanvas');

  let rotationAngle = 0;
  let capturedImageObj = null; // Image object from capture
  let cropRect = null; // Area crop {x, y, width, height}
  let scanResults = [];

  // Setup camera
  navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
  .then(stream => {
    video.srcObject = stream;
  })
  .catch(err => alert("Tidak bisa akses kamera: " + err));

  // Capture frame from video
  captureBtn.addEventListener('click', () => {
    const w = video.videoWidth;
    const h = video.videoHeight;
    hiddenCanvas.width = w;
    hiddenCanvas.height = h;
    const ctx = hiddenCanvas.getContext('2d');
    ctx.drawImage(video, 0, 0, w, h);
    const dataURL = hiddenCanvas.toDataURL('image/png');

    // Load image to img element
    capturedImg.src = dataURL;
    rotationAngle = 0;
    cropRect = null;
    cropPreviewContainer.style.display = "none";
    resultMessage.textContent = "Gambar berhasil di-capture. Klik area angka di gambar.";
    resultMessage.style.color = "green";

    // Create Image object for processing
    capturedImageObj = new Image();
    capturedImageObj.src = dataURL;
  });

  // Klik di gambar hasil capture => buat crop area
  capturedImg.addEventListener('click', (e) => {
    if (!capturedImageObj) return;

    const rect = capturedImg.getBoundingClientRect();
    const scaleX = capturedImageObj.width / rect.width;
    const scaleY = capturedImageObj.height / rect.height;

    const clickX = (e.clientX - rect.left) * scaleX;
    const clickY = (e.clientY - rect.top) * scaleY;

    const cropSize = 150; // ukuran crop kotak
    const x = Math.max(0, Math.min(clickX - cropSize/2, capturedImageObj.width - cropSize));
    const y = Math.max(0, Math.min(clickY - cropSize/2, capturedImageObj.height - cropSize));

    cropRect = { x, y, width: cropSize, height: cropSize };
    rotationAngle = 0; // reset rotasi saat area baru dipilih

    drawCropPreview();

    cropPreviewContainer.style.display = "block";
    resultMessage.textContent = "Area crop dipilih, bisa putar dan scan.";
  });

  function drawCropPreview() {
    if (!cropRect || !capturedImageObj) return;

    const ctx = cropPreview.getContext('2d');
    const w = cropRect.width;
    const h = cropRect.height;

    // canvas disesuaikan ukuran crop
    cropPreview.width = w;
    cropPreview.height = h;

    ctx.clearRect(0, 0, w, h);

    ctx.save();
    // rotasi di tengah canvas crop
    ctx.translate(w/2, h/2);
    ctx.rotate(rotationAngle * Math.PI / 180);
    ctx.translate(-w/2, -h/2);

    // gambar crop dari captured image
    ctx.drawImage(
      capturedImageObj,
      cropRect.x, cropRect.y, w, h, // crop source
      0, 0, w, h                    // canvas dest
    );
    ctx.restore();
  }

  rotateCropBtn.addEventListener('click', () => {
    if (!cropRect) return;
    rotationAngle = (rotationAngle + 90) % 360;
    drawCropPreview();
    resultMessage.textContent = "Area crop diputar " + rotationAngle + "°.";
  });

  scanCropBtn.addEventListener('click', () => {
    if (!cropRect) return;
    resultMessage.textContent = "Memproses OCR...";
    resultMessage.style.color = "black";

    cropPreview.toBlob(blob => {
      Tesseract.recognize(blob, 'eng').then(({ data: { text } }) => {
        const angkaStr = text.replace(/\D/g, '');
        if (!angkaStr) {
          resultMessage.textContent = "Tidak ada angka terdeteksi.";
          resultMessage.style.color = "red";
          return;
        }
        const angka = parseInt(angkaStr, 10);
        scanResults.push(angka);
        updateTable();
        resultMessage.textContent = "Berhasil scan angka: " + formatRibuan(angka);
        resultMessage.style.color = "green";
      }).catch(err => {
        resultMessage.textContent = "Gagal OCR: " + err;
        resultMessage.style.color = "red";
      });
    });
  });

  function updateTable() {
    scanListBody.innerHTML = "";
    scanResults.forEach((num, i) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${i+1}</td>
        <td>${formatRibuan(num)}</td>
        <td><button class="delete-btn" data-index="${i}">Hapus</button></td>
      `;
      scanListBody.appendChild(row);
    });
    const total = scanResults.reduce((acc, val) => acc + val, 0);
    totalValueCell.textContent = formatRibuan(total);
  }

  scanListBody.addEventListener("click", e => {
    if (e.target.classList.contains("delete-btn")) {
      const idx = parseInt(e.target.getAttribute("data-index"));
      if (!isNaN(idx)) {
        scanResults.splice(idx, 1);
        updateTable();
        resultMessage.textContent = "Data berhasil dihapus.";
        resultMessage.style.color = "green";
      }
    }
  });

  function formatRibuan(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }
</script>

</body>
</html>
